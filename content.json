{"meta":{"title":"Hexo","subtitle":null,"description":null,"author":"John Doe","url":"http://yoursite.com"},"pages":[],"posts":[{"title":"FileName","slug":"FileName","date":"2018-09-19T09:48:32.000Z","updated":"2018-09-19T09:50:54.215Z","comments":true,"path":"2018/09/19/FileName/","link":"","permalink":"http://yoursite.com/2018/09/19/FileName/","excerpt":"","text":"如何升级Cloudera Manager和CDH标签（空格分隔）： 未分类 ##1.Cloudera升级概述## 下面描述的流程适用于由Cloudera Manager管理的集群，对于不是由Cloudera Manager管理的集群升级，请参考：https://www.cloudera.com/documentation/enterprise/latest/topics/cdh_ig_upgrade_command_line.html#xd_583c10bfdbd326ba--5a52cca-1476e7473cd--7f99 你可以使用tarballs或operating system packages来升级Cloudera Manager，然后使用packages或parcels来升级CDH。同时有可能还需要安装一个新版JDK。升级Cloudera Manager的同时Cloudera Navigator也会被升级。 CDH和Cloudera Manager不用同时升级，但是需要保证Cloudera Manager和CDH版本的兼容。Cloudera Manager可以管理当前或以前的major版本的CDH，或相同minor版本的CDH，或较低minor版本的CDH。比如，Cloudear Manager 5.7.1可以管理CDH5.7.2，CDH5.6.1和CDH4.8.6，但是不能管理CDH5.8.1. Cloudera Manager5.x不能管理CDH3.x。 升级时具体有如下几种选择： ![此处输入图片的描述][1] [1]: https://mmbiz.qpic.cn/mmbiz_png/THumz4762QDbM3QAly6pQeCToAHTmYVOiaH38U2NqfeV7icJW5U4D36DKf6Vzwfdia4RMclWiczuhIQuV5LT5qGCKw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1 评估升级影响 一般需要规划一个足够长的维护窗口(停机时间)进行升级。根据需要升级的组件，集群的节点数，以及不同的硬件情况，你可能需要一整天来进行升级。开始升级之前，你需要做好一些前置条件准备以及关键数据备份，这篇文档在讲述升级步骤时也会说明。升级之前，需要查阅Cloudera Manager的https://www.cloudera.com/documentation/enterprise/release-notes/topics/rg_release_notes.html，了解API更改，不推荐的功能，新的功能以及不兼容的更改。同时需要检查https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html来确认支持的操作系统，JDK，数据库和其他组件。一共有三种版本的升级：major，minor和maintenance。 Major升级Major版本的升级通常有以下特征：Hadoop的大版本变化，涉及很多更新内容 不兼容的数据格式 Cloudera Manager界面的重大变化 Cloudera Manager的数据库schema变动，不过可以在升级过程中自动被处理 需要较长的停机时间 需要重新部署客户端 你也可以只升级major版本，而保持minor版本不变，比如你可以从4.8.1升级到5.8.0.为了方便下一个major版本的升级(CDH6)，我们建议您现在可以将集群升级到5.xMinor版本升级Minor版本升级是指基于同样的major版本将minor版本进行升级，比如从5.4.x升级到5.8.x，一般有以下特征： 新的功能 Bug修复 可能存在的数据库schema更改会在Cloudera Manager升级时自动被处理一般来说，minor版本的升级不包括不兼容的更改或者数据格式的变化。客户端配置(https://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_client_config.html#cmug_topic_5_9)会被重置。Maintenance版本升级Maintenance版本升级主要是重大bug修复或者解决一些安全问题。不会有兼容性修改和新功能。 Cloudera Manager升级概述 升级Cloudera Manager包括以下步骤：1.在CM节点上升级Cloudera Manager Server，使用操作系统的命令，比如Redhat的yum。也可以手动通过tarballs来升级。tarballs升级比较适合集群中已经有一些可以同时操作多台机器的脚本，程序或工具。2.在所有主机上升级Cloudera Manager agent，Cloudera Manager的升级向导可以帮助你升级agent(JDK升级可选)，同时也可以手动的通过tarballs升级JDK和agent。在这个过程中，CDH并不会被升级。Cloudera Manager升级，可以参考官网文档：https://www.cloudera.com/documentation/enterprise/latest/topics/cm_upgrade.html#concept_q1q_mbs_wx CDH升级概述CDH升级包含Hadoop相关组件的升级，你可以使用Cloudera Manager来升级CDH，采用parcel或package的方式都可以。3.1使用Parcel升级(同时适用于滚动升级)我们建议使用parcels来升级CDH，因为Cloudera Manager管理这些parcels自动下载，分发和激活。有两种方式的升级：Parcels:需要重启集群才能完成升级。滚动升级：如果HDFS启用了高可用HA，可以在不重启集群的情况下进行滚动升级。为了简化升级步骤，可以考虑从package切换到parcels，这样Cloudera Manager可以大大简化升级步骤。在升级CDH5的时候你从package切换到parcels也可以。3.2使用Packages升级使用packages升级需要你提前下载好需要升级的packages，然后手动的运行package更新命令来升级，注意所有主机都需要进行相同的操作。从Cloudera Manager5.3开始，CDH提供向导式的升级包括major版本升级(CDH5到CDH5)，minor版本升级(CDH5.x到5.y)和maintenance版本升级(CDHa.b.x到CDHa.b.y)。无论你是使用parcels安装还是package都支持，但是package需要你手动安装和升级，但是parcels可以被Cloudera Manager自动安装和升级。 Cloudera Navigator升级概述当升级Cloudera Manager的时候，Cloudera Navigator Metadata和Audit servers会被自动升级。你还可以升级其他的Navigator组件比如Cloudera Navigator Key Trustee Server, Cloudera Navigator Key HSM和Cloudera Navigator Encrypt。当然也可以选择不升级。 JDK升级在升级Cloudera Manager和CDH之前，请确保集群内的所有主机都是使用受支持的Oracle JDK，参考：https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html。同时，所有主机必须使用相同版本的JDK：参考：https://www.cloudera.com/documentation/enterprise/latest/topics/cdh_cm_upgrading_to_jdk8.html#xd_583c10bfdbd326ba-590cb1d1-149e9ca9886--7c46 2.Minor版本升级升级前置条件： 1.确保当前系统版本支持您要升级到的新版本CDH5和Cloudera Manager5 2.原Cloudera Manager和CDH的版本为5.4.3 3.Cloudera Manager和CDH的目标升级版本为5.11.1 Cloudera Manager升级1.1升级前准备1.1.1Cloudera Manager的yum源配置1.准备待升级rpm包1234567wget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-agent-5.11.1-1.cm5111.p0.9.el6.x86_64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-daemons-5.11.1-1.cm5111.p0.9.el6.x86_64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-server-5.11.1-1.cm5111.p0.9.el6.x86_64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/cloudera-manager-server-db-2-5.11.1-1.cm5111.p0.9.el6.x86_64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/enterprise-debuginfo-5.11.1-1.cm5111.p0.9.el6.x86_64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/jdk-6u31-linux-amd64.rpmwget http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/RPMS/x86_64/oracle-j2sdk1.7-1.7.0+update67-1.x86_64.rpm 2.将下载的安装包放在/var/www/html/cm5.11.1目录下 ![此处输入图片的描述][4] 进入cm5.11.1目录，运行命令： 1[ec2-user@ip-172-31-8-141 cm5.11.1]$ sudo createrepo . ![此处输入图片的描述][5] 3.验证是否能通过浏览器访问 ![此处输入图片的描述][6] 4.配置/etc/yum.repos.d/cloudera-manager.repo文件，内容如下 123name = Cloudera Manager, Version 5.11.1baseurl = http://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5.11.1/gpgcheck = 0 5.测试yum源是否正常 ![此处输入图片的描述][7] **1.1.2备份Cloudera Manager数据库** 1.停止Cloudera Management Service服务 2.备份Cloudera Manager数据库，在命令行执行如下命令 cmdb_bak]$ mysqldump -u cm -p --databases cm >cm.dump1234[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u nas -p --databases nas &gt;nas.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u nms -p --databases nms &gt;nms.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u am -p --databases am &gt;am.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u rm -p --databases rm &gt;rm.dump ![此处输入图片的描述][8] 查找数据库相关的信息，可从如下文件中查找 ClouderaManager Server的数据库信息，通过配置文件/etc/cloudera-scm-server/db.properties获取 ![此处输入图片的描述][9] 其它服务的数据库信息，可以通过CM管理界面获取 ![此处输入图片的描述][10] **1.2升级步骤** 1.停止Cloudera Management Service服务 2.停止Cloudera Manager Server和agent 3.在Cloudera Manager上备份以下目录 1[ec2-user@ip-172-31-8-141 cm_bak]$ sudo yum -y upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent 检查是否安装成功 1[ec2-user@ip-172-31-8-141 cm_bak]$ rpm -qa |grep cloudera- 注意文件目录权限与原数据目录权限一致。 4.运行以下命令进行Cloudera Manager Server升级 1[ec2-user@ip-172-31-8-141 cm_bak]$ sudo yum -y upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent 检查是否安装成功 cm_bak]$ rpm -qa |grep cloudera-```125.启动Cloudera Manager Server服务 [ec2-user@ip-172-31-8-141 cloudera-scm-agent]$ sudo service cloudera-scm-server start 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455 6.登录Cloudera Manager管理控制台，显示升级向导 ![此处输入图片的描述][11] 7.选择升级Cloudera Manager Agent软件包，继续 ![此处输入图片的描述][12] 8.选择“自定义存储库”，配置1.2章节的地址，点击“继续” ![此处输入图片的描述][13] 9.选择JDK选择，点击“继续” ![此处输入图片的描述][14] 10.根据要求输入SSH登录凭证，点击“继续” ![此处输入图片的描述][15] 11.等待安装完成，点击“继续” ![此处输入图片的描述][16] 12.检查完成，点击“完成” ![此处输入图片的描述][17] 13.进入审核更改向导界面，点击“继续” ![此处输入图片的描述][18] 14.选择重启Cloudera Management Service，点击“继续” ![此处输入图片的描述][19] 15.服务重启成功，点击“完成” ![此处输入图片的描述][20] Cloudera Manager在升级后报告过时的配置，请重新启动集群服务并重新部署客户端配置 ![此处输入图片的描述][21] ## 3.Cloudera Manager升级验证 ## 1.查看Cloudera Manager版本 ![此处输入图片的描述][22] 版本显示为升级后版本 2.验证Agent是否向Cloudera Manager发送心跳 ![此处输入图片的描述][23] 默认情况下，该心跳为15s一次； 3.检查所有主机 ![此处输入图片的描述][24] 4.集群历史监控数据 ![此处输入图片的描述][25] 2. CDH升级 **2.1升级前准备 2.1.1准备CDH的parcels包**1.选择cdh5.11.1版本下载对应的parcels wget http://archive.cloudera.com/cdh5/parcels/5.11.1/CDH-5.11.1-1.cdh5.11.1.p0.4-el6.parcelwget http://archive.cloudera.com/cdh5/parcels/5.11.1/CDH-5.11.1-1.cdh5.11.1.p0.4-el6.parcel.sha1wget http://archive.cloudera.com/cdh5/parcels/5.11.1/manifest.json123456789101112132.将下载下来的3个文件，放在/var/www/html/cdh5.11.1目录下3.测试通过http是否能正常访问![此处输入图片的描述][26]配置完成后，供后面升级CDH使用**2.2升级流程**1.停止集群服务2.备份NameNode上的HDFS Metastore![此处输入图片的描述][27]在NameNode节点上备份该目录到指定目录下 [ec2-user@ip-172-31-8-141 dfs]$ cd /dfs/[ec2-user@ip-172-31-8-141 dfs]$ sudo tar -czvf /home/ec2-user/upgrade/nn_bak/nn_backup.tar.gz nn/123.备份数据库 [ec2-user@ip-172-31-8-141 hadoopdb_bak]$ mysqldump -u hue -p –database hue &gt;hue.dump[ec2-user@ip-172-31-8-141 hadoopdb_bak]$ mysqldump -u hive -p –database metastore &gt;metastore.dump[ec2-user@ip-172-31-8-141 hadoopdb_bak]$ mysqldump -u oozie -p –database oozie &gt;oozie.dump[ec2-user@ip-172-31-8-141 hadoopdb_bak]$ mysqldump -u sentry -p –database sentry &gt;sentry.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u cm -p –databases cm &gt;cm.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u nas -p –databases nas &gt;nas.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u nms -p –databases nms &gt;nms.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u am -p –databases am &gt;am.dump[ec2-user@ip-172-31-8-141 cmdb_bak]$ mysqldump -u rm -p –databases rm &gt;rm.dump123456789101112131415161718192021222324252627282930314.向集群中添加新版的CDH存储库![此处输入图片的描述][28]![此处输入图片的描述][29]![此处输入图片的描述][30]5.运行升级向导![此处输入图片的描述][31]6.进入升级向导界面![此处输入图片的描述][32]7.确认CDH版本是否正确，点击“继续”8.选择“是”，点击“继续”![此处输入图片的描述][33]9.点击“继续”![此处输入图片的描述][34]10.等待安装完成后，点击“继续”![此处输入图片的描述][35]11.检查主机完成后，点击“继续”12.选择完整集群升级，点击“继续”13.等待升级集群命令完成，点击“继续”![此处输入图片的描述][36]14.集群升级成功![此处输入图片的描述][37]15.最终化元数据升级在最终化元数据之前，进行几天甚至几周的运行观察集群是否正常，在发现所有任务都没有任何异常情况后，再进行最终化元数据操作。一旦进行最终化元数据之后，就不能回滚到老的版本了，除非有数据备份。对NameNode的主备节点都执行最终化元数据升级操作：![此处输入图片的描述][38]![此处输入图片的描述][39]**2.3功能验证**1.运行一个MapReduce作业 登录集群服务器，操作如下指令 sudo -u hdfs hadoop jar /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar pi 10 100 ``` ![此处输入图片的描述][40] 2.用Hue测试 Hue正常登录，通过Hue操作HBase，向HBase中新建一个test表 向test表中添加一条数据 数据添加成功 通过hbase-shell查看该表是否存在 3.测试hive 4.。。。。","categories":[],"tags":[]},{"title":"Hello World","slug":"hello-world","date":"2018-09-19T08:44:05.037Z","updated":"2018-09-19T08:44:05.038Z","comments":true,"path":"2018/09/19/hello-world/","link":"","permalink":"http://yoursite.com/2018/09/19/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new \"My New Post\" More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[]}]}